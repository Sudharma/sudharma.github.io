<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>Elastic Fluentd Kibana on Kubernetes</title><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=https://fonts.googleapis.com rel=preconnect><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100&display=swap" rel=stylesheet><style>body{--primary-color:#698bcf;--primary-pale-color:#698bcf1c;--text-color:#3c4043;--text-pale-color:#9aa2b9;--bg-color:#fff;--highlight-mark-color:#5f75b045;--callout-note-color:#698bcf;--callout-important-color:#9971d9;--callout-warning-color:#c99054;--callout-alert-color:#d35757;--callout-question-color:#4985a2;--callout-tip-color:#3ea06f;--main-font:'Signika',ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--code-font:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--homepage-max-width:750px;--main-max-width:750px;--avatar-size:70px;--paragraph-font-size:18px;--paragraph-line-height:1.75;--aside-font-size:16px;--img-border-radius:0;--inline-code-border-radius:2px}body.dark{--primary-color:#698bcf;--primary-pale-color:#698bcf1c;--text-color:#d8dbe1;--text-pale-color:#8d9096;--bg-color:#202124;--highlight-mark-color:#5f75b045;--callout-note-color:#698bcf;--callout-important-color:#9971d9;--callout-warning-color:#c99054;--callout-alert-color:#d35757;--callout-question-color:#4985a2;--callout-tip-color:#3ea06f}</style><link href=/main.css rel=stylesheet><link href=/hl-light.css id=hl rel=stylesheet><body class=post><script>if(localStorage.getItem('theme')=='dark'){document.body.classList.add('dark');const a=document.querySelector('link#hl');if(a)a.href='/hl-dark.css'}</script><header class=blur><div id=header-wrapper><nav><a href=/>chaosguru</a><button aria-label="toggle expand" class=separator id=toggler>::</button><span class="wrap left fold">{</span><a href=/blog>Blog</a><span class="wrap-separator fold">,</span><a class=fold href=/til>TIL</a><span class="wrap right fold">} ;</span></nav><div id=btns><a aria-label="rss feed" href=/blog/feed.xml><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M3 17C5.20914 17 7 18.7909 7 21H3V17ZM3 10C9.07513 10 14 14.9249 14 21H12C12 16.0294 7.97056 12 3 12V10ZM3 3C12.9411 3 21 11.0589 21 21H19C19 12.1634 11.8366 5 3 5V3Z" fill=currentColor></path></svg></a><button aria-label="theme switch" data-moon-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill="currentColor"></path></svg>' data-sun-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill="currentColor"></path></svg>' id=theme-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></button><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><div id=wrapper><div id=blank></div><aside class=blur><nav><ul><li><a class=h2 href=#pre-requisites>Pre-requisites</a><li><a class=h2 href=#certificates>Certificates</a><li><a class=h2 href=#configure-secrets>Configure Secrets</a><li><a class=h2 href=#configure-helm-values>Configure helmÂ values</a> <ul><li><a class=h3 href=#elastic-configurations>Elastic configurations</a><li><a class=h3 href=#fluentd-configurations>Fluentd configurations</a><li><a class=h3 href=#kibana-configurations>Kibana Configurations</a></ul><li><a class=h2 href=#helm-chart-installations>Helm Chart installations</a><li><a class=h2 href=#references>References:</a></ul></nav><button aria-label="back to top" id=back-to-top><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M11.9997 10.8284L7.04996 15.7782L5.63574 14.364L11.9997 8L18.3637 14.364L16.9495 15.7782L11.9997 10.8284Z" fill=currentColor></path></svg></button></aside><main><div><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' id=copy-cfg style=display:none></div><article data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z" fill="currentColor"></path></svg>' class=prose><h1>Elastic Fluentd Kibana on Kubernetes</h1><div id=post-info><div id=date><span id=publish>2020-04-12</span></div><div id=tags><a href=https://sudharma.github.io/tags/kubernetes><span>#</span>kubernetes</a><a href=https://sudharma.github.io/tags/elk><span>#</span>elk</a></div></div><p>There are lots of articles explaining the installations of EFK stack individually or via scripts which can solve the purpose of getting the Stack up and running. In this article I want to have a complete installation as a suite of EFK stack with X-pack features such as Authentication and SSL with Elastic 7.6.2. At the end of the article I have linked the git repository with complete set!<p><em><strong>From official Elastic doc.</strong></em><blockquote><p>Elastic released some security features for free as part of the default distribution (Basic license) starting in Elastic Stack 6.8 and 7.1. This new feature offering includes the ability to encrypt network traffic using SSL, create and manage users, define roles that protect index and cluster-level access, and fully secure Kibana.</blockquote><p>After this article you shall be able to install EFK on your cluster up and running. As per the project needs and scope of the usage you can make use of different subscriptions provided by Elastic.<h3 id=pre-requisites>Pre-requisites<a aria-label="Anchor link for: pre-requisites" class=zola-anchor href=#pre-requisites>#</a></h3><ol><li>Understanding of Elastic Search (Basic). I shall soon write how ES stack can be used.<li>Basic understanding of fluentd and kibana to begin.<li>Understanding of Kubernetes (Moderate). If working with cloud provider more understand would be better.<li>Helm charts and some scripting.</ol><p><strong>Background</strong><p><a href=https://www.digitalocean.com/community/tutorials/how-to-set-up-an-elasticsearch-fluentd-and-kibana-efk-logging-stack-on-kubernetes><em>Here</em></a> it is very nicely explained about the EFK manifests in Kubernetes.<h3 id=certificates>Certificates<a aria-label="Anchor link for: certificates" class=zola-anchor href=#certificates>#</a></h3><p>We will be installing 3 Node Elastic cluster as <code>StatefulSet</code>, since we are using the SSL for elastic search we would want to generate the certificate for the elastic nodes! The Encryption is done within the cluster as well as external HTTP calls. (Later we will talk about the service names aka DNS names used in the certificates) For now this script will create certificate for us by executing the commands in the sample docker image of elastic.<pre class="language-Bash z-code" data-lang=Bash><code class=language-Bash data-lang=Bash><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">!/bin/bash</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-set z-shell">set</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">-</span>e</span></span>
<span class="z-keyword z-control z-conditional z-if z-shell">if</span> <span class="z-meta z-function-call z-arguments z-shell"><span class="z-support z-function z-double-brace z-begin z-shell">[[</span> <span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">-</span>z</span> <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">CA_PASSWD</span></span> <span class="z-support z-function z-double-brace z-end z-shell">]]</span></span> <span class="z-keyword z-operator z-logical z-or z-shell">||</span> <span class="z-meta z-function-call z-arguments z-shell"><span class="z-support z-function z-double-brace z-begin z-shell">[[</span> <span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">-</span>z</span> <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">CERT_PASSWD</span></span> <span class="z-support z-function z-double-brace z-end z-shell">]]</span></span> <span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-keyword z-control z-conditional z-then z-shell">then</span>
  <span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span> Provide CA Password [CA_PASSWD] and Cert password [CERT_PASSWD] before hand<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
  <span class="z-meta z-function-call z-shell"><span class="z-support z-function z-exit z-shell">exit</span></span><span class="z-meta z-function-call z-arguments z-shell"> 1</span>
<span class="z-keyword z-control z-conditional z-end z-shell">fi</span>

<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">rm</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>f</span> elastic-certificates.p12 elastic-certificate.pem elastic-stack-ca.p12</span> <span class="z-keyword z-operator z-logical z-or z-shell">||</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">true</span></span>
<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">password=$$([ ! -z "$$ELASTIC_PASSWORD" ] && echo $$ELASTIC_PASSWORD || echo $$(docker run --rm $(ELASTICSEARCH_IMAGE) /bin/sh -c "< /dev/urandom tr -cd '[:alnum:]' | head -c20")) && \</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">docker</span></span><span class="z-meta z-function-call z-arguments z-shell"> run<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>name</span> elastic-helm-charts-certs<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>i</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>w</span> /app <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-expansion z-parameter z-begin z-shell">{</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-variable z-other z-readwrite z-shell">ELASTICSEARCH_IMAGE</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-keyword z-operator z-assignment z-shell">:-</span></span><span class="z-meta z-group z-expansion z-parameter z-shell">docker.elastic.co/elasticsearch/elasticsearch:7.6.2</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-section z-expansion z-parameter z-end z-shell">}</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span>/bin/sh<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>c</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span> <span class="z-constant z-character z-escape z-shell">\
</span>elasticsearch-certutil ca --out /app/elastic-stack-ca.p12 --pass '<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">CA_PASSWD</span></span>' && <span class="z-constant z-character z-escape z-shell">\
</span>elasticsearch-certutil cert --name elasticsearch-master-cert --dns elasticsearch-master,elasticsearch-master-0.elasticsearch-master-headless,elasticsearch-master-1.elasticsearch-master-headless,elasticsearch-2.elasticsearch-master-headless --ca /app/elastic-stack-ca.p12 --pass '<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">CERT_PASSWD</span></span>' --ca-pass '<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">CA_PASSWD</span></span>' --out /app/elastic-certificates.p12<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span> <span class="z-keyword z-operator z-logical z-and z-shell">&&</span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mkdir</span></span><span class="z-meta z-function-call z-arguments z-shell"> certs</span> <span class="z-keyword z-operator z-logical z-and z-shell">&&</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">docker</span></span><span class="z-meta z-function-call z-arguments z-shell"> cp elastic-helm-charts-certs:/app/elastic-stack-ca.p12 certs/</span> <span class="z-keyword z-operator z-logical z-and z-shell">&&</span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">docker</span></span><span class="z-meta z-function-call z-arguments z-shell"> cp elastic-helm-charts-certs:/app/elastic-certificates.p12 efk/certs/</span> <span class="z-keyword z-operator z-logical z-and z-shell">&&</span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">docker</span></span><span class="z-meta z-function-call z-arguments z-shell"> rm<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>f</span> elastic-helm-charts-certs</span>
<span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>elastic certificate created successfully and stored at location <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">pwd</span></span>/certs. <span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> Extract the CA certificate in PEM format for kibana to ssl verify elastic TLS</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openssl</span></span><span class="z-meta z-function-call z-arguments z-shell"> pkcs12<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>nodes</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>passin</span> pass:<span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">CA_PASSWD</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>in</span> efk/certs/elastic-stack-ca.p12<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>out</span> efk/certs/elastic-ca.pem</span>
<span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>CA certificate(pem format) created successfully and stored at location <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">pwd</span></span>/certs. <span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
</span></code></pre><p><strong>TL;DR</strong><p>Scripts create 2 certificates in pkc12 format. one is CA and other is the certificate. The certificates are used for volume mounts on elastic nodes.<p><strong>Detailed(Skip if you already know aboutÂ certs..)</strong><p>Elastic has already provided scripts to generate certificates for us. If you can exec the elastic pod/container you can find the scripts as below. More details <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/configuring-tls.html#tls-transport>here</a><pre class="language-Bash z-code" data-lang=Bash><code class=language-Bash data-lang=Bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">/usr/share/elasticsearch/bin/elasticsearch-certutil</span></span>
</span></code></pre><p>Two certificates are created one is self signed CA(elastic-stack-ca.p12) and other is the Certificate(elastic-certificates.p12) signed out of this CA. They are in pkcs12 format which has the private key and protected with password. It is recommended to provide passwords to the certificates as argument to the script. Kibana needs the CA in pem format for verifying the elastic connection; it is also generated.<h3 id=configure-secrets>Configure Secrets<a aria-label="Anchor link for: configure-secrets" class=zola-anchor href=#configure-secrets>#</a></h3><ol><li>K8s Secret for elastic credentials with userId and password.<li>K8s Secret for elastic certificate in p12 format. Needed to mount on the elastic nodes.<li>K8s Secret for elastic CA in pem format. This is needed for kibana for ssl verify.</ol><h3 id=configure-helm-values>Configure helmÂ values<a aria-label="Anchor link for: configure-helm-values" class=zola-anchor href=#configure-helm-values>#</a></h3><p>Next step is to configure the elastic properties via helm values file.<h4 id=elastic-configurations>Elastic configurations<a aria-label="Anchor link for: elastic-configurations" class=zola-anchor href=#elastic-configurations>#</a></h4><p>Enable the xpack security and configure the keystore and truststoreÂ . Configure the Elastic user and password for authn. Configure the certificate paths and mount the certificates via secret. Set the password which is used while creating the certificates.(I have used random passÂ , recommended to change it).<p><em>NoteÂ : The default clustername is elasticsearch hence the master created for elastic will be elasticsearch-master.</em><pre class="language-yaml z-code" data-lang=yaml><code class=language-yaml data-lang=yaml><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">extraEnvs</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>  
<span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">ELASTIC_PASSWORD</span>    
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">valueFrom</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>      
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">secretKeyRef</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>        
      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">elastic-credentials</span>        
      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">key</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">password</span>  
<span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">ELASTIC_USERNAME</span>    
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">valueFrom</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>      
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">secretKeyRef</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>        
      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">elastic-credentials</span>        
      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">key</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">username</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">esConfig</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>    
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">elasticsearch.yml</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-keyword z-control z-flow z-block-scalar z-literal z-yaml">|</span><span class="z-invalid z-illegal z-expected-comment-or-newline z-yaml">      </span>
<span class="z-string z-unquoted z-block z-yaml">    xpack.security.enabled: true             
    xpack.security.transport.ssl.enabled: true      
    xpack.security.transport.ssl.verification_mode: certificate      
    xpack.security.transport.ssl.keystore.path: 
        /usr/share/elasticsearch/config/certs/elastic-certificates.p12      
    xpack.security.transport.ssl.truststore.path:    
       /usr/share/elasticsearch/config/certs/elastic-certificates.p12        
</span>   <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">xpack.security.http.ssl.enabled</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-constant z-language z-boolean z-yaml">true</span>        
   <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">xpack.security.http.ssl.truststore.path</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> 
       <span class="z-string z-unquoted z-plain z-out z-yaml">/usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>      
   <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">xpack.security.http.ssl.keystore.path</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> 
      <span class="z-string z-unquoted z-plain z-out z-yaml">/usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>      
   <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">xpack.security.transport.ssl.keystore.password</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">$0meR@nd0mP@ss</span>         
   <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">xpack.security.transport.ssl.truststore.password</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">$0meR@nd0mP@ss</span>      
   <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">xpack.security.http.ssl.keystore.password</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">$0meR@nd0mP@ss</span>      
   <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">xpack.security.http.ssl.truststore.password</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">$0meR@nd0mP@ss</span>  
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">secretMounts</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
  <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">elastic-certificates</span>    
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">secretName</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">elastic-certificates</span>    
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">path</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">/usr/share/elasticsearch/config/certs</span>
</span></code></pre><h4 id=fluentd-configurations>Fluentd configurations<a aria-label="Anchor link for: fluentd-configurations" class=zola-anchor href=#fluentd-configurations>#</a></h4><p>Its straight and simple! provide the elasticsearch endpoint service and also the logs from the kube-system and istio-system are not included! This is optional and you can remove/add as per your needs.<pre class="language-yaml z-code" data-lang=yaml><code class=language-yaml data-lang=yaml><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">extraConfigMaps</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> Ignoring the logs from kube-system and istio-
</span>         <span class="z-string z-unquoted z-plain z-out z-yaml">system</span> 
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">out.conf</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-keyword z-control z-flow z-block-scalar z-literal z-yaml">|</span><span class="z-storage z-modifier z-chomping-indicator z-yaml">-</span><span class="z-invalid z-illegal z-expected-comment-or-newline z-yaml"> </span>
<span class="z-string z-unquoted z-block z-yaml">    &LTmatch kubernetes.var.log.containers.**_kube-system_**> 
      @type null 
    &LT/match> 
    &LTmatch kubernetes.var.log.containers.**_istio-system_**> 
      @type null 
    &LT/match> 
    &LTmatch kubernetes.var.log.containers.**_efk_**> 
      @type null 
    &LT/match> 
</span><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">elasticsearch</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> 
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">host</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">elasticsearch-master</span> 
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">auth</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> 
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">enabled</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-constant z-language z-boolean z-yaml">true</span> 
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">user</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>elastic<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span> <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> this is just for testing. Use Kibana user 
</span>         <span class="z-string z-unquoted z-plain z-out z-yaml">instead</span> 
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">password</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>elastic$123<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span> 
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">port</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-constant z-numeric z-integer z-decimal z-yaml">9200</span> 
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">scheme</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>https<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span> 
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">sslVerify</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-constant z-language z-boolean z-yaml">false</span>
</span></code></pre><h4 id=kibana-configurations>Kibana Configurations<a aria-label="Anchor link for: kibana-configurations" class=zola-anchor href=#kibana-configurations>#</a></h4><p>It is again simple and straight! Configure the Elastic Search connections via secret and provide the elastic-ca.pem file as volume mount for ssl verifying the elastic service<pre class="language-yaml z-code" data-lang=yaml><code class=language-yaml data-lang=yaml><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">extraEnvs</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> 
<span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-single z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">'</span>ELASTICSEARCH_USERNAME<span class="z-punctuation z-definition z-string z-end z-yaml">'</span></span> 
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">valueFrom</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> 
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">secretKeyRef</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> 
      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">elastic-credentials</span> 
      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">key</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">username</span> 
<span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-single z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">'</span>ELASTICSEARCH_PASSWORD<span class="z-punctuation z-definition z-string z-end z-yaml">'</span></span> 
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">valueFrom</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> 
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">secretKeyRef</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> 
      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">elastic-credentials</span> 
      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">key</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">password</span> 
<span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-single z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">'</span>KIBANA_ENCRYPTION_KEY<span class="z-punctuation z-definition z-string z-end z-yaml">'</span></span> 
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">valueFrom</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> 
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">secretKeyRef</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> 
      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">kibana</span> 
      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">key</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">encryptionkey</span> 
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">kibanaConfig</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> 
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">kibana.yml</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-keyword z-control z-flow z-block-scalar z-literal z-yaml">|</span><span class="z-invalid z-illegal z-expected-comment-or-newline z-yaml"> </span>
<span class="z-string z-unquoted z-block z-yaml">    elasticsearch.ssl: 
      certificateAuthorities:    
        /usr/share/kibana/config/certs/elasticsearch-ca.pem  `
      verificationMode: certificate # Elastic CA cert for SSL verify secretMounts: 
</span><span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">elastic-ca</span> 
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">secretName</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">elastic-ca-pem</span> <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> Secret Names are hardcoded for 
</span>      <span class="z-string z-unquoted z-plain z-out z-yaml">simplicity</span> 
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">path</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">/usr/share/kibana/config/certs</span>
</span></code></pre><h3 id=helm-chart-installations>Helm Chart installations<a aria-label="Anchor link for: helm-chart-installations" class=zola-anchor href=#helm-chart-installations>#</a></h3><p>Create a simple helm chart and create a new requirements.yaml with all dependencies of efk.<pre class="language-yaml z-code" data-lang=yaml><code class=language-yaml data-lang=yaml><span class="z-source z-yaml"><span class="z-entity z-other z-document z-begin z-yaml">---</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">dependencies</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
<span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>elasticsearch<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span>
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">repository</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>@elastic<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span>
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">version</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>7.6.2<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span>
<span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>fluentd-elasticsearch<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span>
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">repository</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>@kiwigrid<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span>
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">version</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>6.2.3<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span>
<span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>kibana<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span>
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">repository</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>@elastic<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span>
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">version</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>7.6.2<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span>
</span></code></pre><p>Now the values are ready and also the requirements. We just need to install the chart.<pre class="language-Bash z-code" data-lang=Bash><code class=language-Bash data-lang=Bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> helm repo add elastic https://helm.elastic.co</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> helm repo add kiwigrid https://kiwigrid.github.io</span> <span class="z-keyword z-operator z-logical z-and z-shell">&&</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">helm</span></span><span class="z-meta z-function-call z-arguments z-shell"> repo update </span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> helm install efk<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>name</span> efk<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>namespace</span> efk</span>
</span></code></pre><p>This will create elasticservice-master as the cluster service and also headless service(elasticsearch-master-headless) for seeding the elastic hosts. The indivudual nodes are identified as FQDN elasticsearch-master-0.elasticsearch-master-headless, elasticsearch-master-1.elasticsearch-master-headless, elasticsearch-master-1.elasticsearch-master-headlessÂ . These are exactly the DNS names used in the certificates. Additionally elasticsearch-master is also added in the certificate since kibana would also use this certificate as http client.(I am using same certificate here for both transport layer security and http security)<p>The kibana is currently running as k8s service with type as clusterIP. The charts of kibana provide way to install ingress so the service can be available outside.!<p>You can port-forward the kibana pod and try with the login user we created.<pre class="language-Bash z-code" data-lang=Bash><code class=language-Bash data-lang=Bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-storage z-modifier z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">POD_NAME</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">kubectl</span></span><span class="z-meta z-function-call z-arguments z-shell"> get pods<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>namespace</span> efk<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>l</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>app=kibana,release=kibana<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>o</span> jsonpath=<span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>{.items[0].metadata.name}<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span></span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>Visit http://127.0.0.1:5601 to use Kibana<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">kubectl</span></span><span class="z-meta z-function-call z-arguments z-shell"> port-forward<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>namespace</span> efk <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">POD_NAME</span></span> 5601:5601</span>
</span></code></pre><p><em><strong>Note:</strong></em><ol><li>This article is a vanilla install. You can use sealed secrets for making it more secure<li>The passwords can be securely mounted as keystore secret which will be picked by init container and added into the pods but this is not working currently.</ol><h3 id=references>References:<a aria-label="Anchor link for: references" class=zola-anchor href=#references>#</a></h3><ul><li><a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/configuring-tls.html#tls-transport>Encrypting communications in Elasticsearch | Elasticsearch Reference [7.6] | Elastic</a><li><a href=https://github.com/Sudharma/efk-k8s>Sudharma/efk-k8s</a><li><a href=https://github.com/elastic/helm-charts/tree/main/elasticsearch/examples/security>Elastic helm charts</a><li><a href="https://medium.com/r/?url=https%3A%2F%2Fwww.digitalocean.com%2Fcommunity%2Ftutorials%2Fhow-to-set-up-an-elasticsearch-fluentd-and-kibana-efk-logging-stack-on-kubernetes">How To Set Up an Elasticsearch, Fluentd and Kibana (EFK) Logging Stack on Kubernetes | DigitalOcean</a></ul></article></div><footer><div class=copyright><p>Â© 2023 Sudharma</div></footer></main></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>